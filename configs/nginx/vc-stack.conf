# Nginx configuration for VC Stack
# Install to: /etc/nginx/sites-enabled/vc-stack.conf

server {
  listen 80;
  server_name _;

  root /opt/tiger/web;
  index index.html;
  client_max_body_size 20G;
  client_body_timeout 600s;

  # SPA 前端路由处理：所有非文件请求重定向到 index.html
  location / {
    # 如果文件/目录不存在，重定向到 index.html（SPA 路由）
    if (!-e $request_filename) {
      rewrite ^(.*)$ /index.html break;
    }
  }

  # 特殊处理：index.html 不缓存
  location = /index.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    access_log off;
  }

  # 静态资源 - 启用缓存
  location ~* ^/assets/ {
    expires 30d;
    add_header Cache-Control "public, immutable";
    access_log off;
  }

  # 配置文件
  location /config/ {
    add_header Cache-Control "no-cache";
    access_log off;
  }

  # WebSocket proxy for console
  location /ws/ {
    proxy_pass http://127.0.0.1:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
  }

  # 反代 API 到后端服务
  location /api/ {
    proxy_request_buffering off;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # 健康检查端点
  location /health {
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    access_log off;
  }

  # 监控指标端点
  location /metrics {
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    access_log off;
  }

  # 拒绝访问某些敏感文件
  location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
  }
}
